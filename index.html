<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë£¨ ë§ˆë¸” í”Œë ˆì´ì–´</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { text-align: center; font-family: 'Apple SD Gothic Neo', sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 400px; margin: 20px auto; }
        .char-btn { font-size: 40px; height: 90px; border: 2px solid #ddd; background: white; border-radius: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #nameInput { font-size: 20px; padding: 15px; width: 80%; border: 3px solid #333; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        
        /* ì£¼ì‚¬ìœ„ ë²„íŠ¼ */
        .dice-btn { width: 160px; height: 160px; font-size: 70px; border-radius: 50%; background: #ff4757; color: white; margin-top: 40px; border: 8px solid #d63031; cursor: pointer; box-shadow: 0 10px #b33939; }
        .dice-btn:disabled { background: #ccc; border-color: #999; box-shadow: none; cursor: not-allowed; transform: translateY(5px); }
        
        /* [ë³µêµ¬ë¨] í™©ê¸ˆì—´ì‡  ë³´ê´€í•¨ ìŠ¤íƒ€ì¼ */
        #goldenKeyStorage { display: none; margin-top: 20px; padding: 20px; background: #fff9c4; border: 4px solid #f1c40f; border-radius: 15px; box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); animation: bounceIn 0.5s ease-out; }
        .confirm-btn { background: #333; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-size: 16px; margin-top: 15px; font-weight: bold; }
        
        /* ì•ŒëŒ ì˜¤ë²„ë ˆì´ */
        #alertOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #dc143c; color: white; z-index: 10000; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        #alertText { font-size: 26px; background: black; padding: 20px; border: 3px solid yellow; border-radius: 15px; margin-top: 20px; width: 85%; }
        
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="alertOverlay">
        <h1 id="alertTitle" style="font-size:38px;">ğŸš¨ ì„œë“ ë°ìŠ¤! ğŸš¨</h1>
        <p id="alertText"></p>
        <h2 style="margin-top:30px; opacity:0.8;">TV í™”ë©´ì„ ì£¼ì‹œí•˜ì„¸ìš”!</h2>
    </div>

    <div id="setup">
        <h1 style="font-size: 35px; color: #ff4757;">ğŸº ì£¼ë£¨ ë§ˆë¸”</h1>
        <input type="text" id="nameInput" placeholder="ì´ë¦„ (ìµœëŒ€ 4ì)" maxlength="4">
        <div class="char-grid">
            <div class="char-btn" onclick="join('ğŸº')">ğŸº</div><div class="char-btn" onclick="join('ğŸ¶')">ğŸ¶</div><div class="char-btn" onclick="join('ğŸ”¥')">ğŸ”¥</div>
            <div class="char-btn" onclick="join('ğŸ˜')">ğŸ˜</div><div class="char-btn" onclick="join('ğŸ¤¢')">ğŸ¤¢</div><div class="char-btn" onclick="join('ğŸ‘»')">ğŸ‘»</div>
            <div class="char-btn" onclick="join('ğŸ·')">ğŸ·</div><div class="char-btn" onclick="join('ğŸ¹')">ğŸ¹</div><div class="char-btn" onclick="join('ğŸ’©')">ğŸ’©</div>
        </div>
    </div>

    <div id="game" style="display:none;">
        <h2 id="myDisplay"></h2>
        
        <div id="goldenKeyStorage">
            <h3 style="margin:0; color: #d35400;">ğŸ—ï¸ í™©ê¸ˆì—´ì‡  íšë“!</h3>
            <p id="storageText" style="font-size: 22px; font-weight: bold; margin: 15px 0; color: #2c3e50;"></p>
            <button class="confirm-btn" onclick="closeKey()">í™•ì¸ / ì‚¬ìš©ì™„ë£Œ</button>
        </div>

        <div id="status" style="margin-top:20px; font-weight:bold; font-size:20px;">ìƒëŒ€ë°© ëŒ€ê¸° ì¤‘...</div>
        <button id="rollBtn" class="dice-btn" onclick="roll()">ğŸ²</button>
        <div id="penaltyLog" style="margin-top:20px; font-size: 24px; color: #ff4757; font-weight: bold;"></div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://jurumable-9fdde-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId, myName, myChar, currentPos = 0, playerList = [];
        
        // í™©ê¸ˆì—´ì‡  ë¦¬ìŠ¤íŠ¸
        const privateKeys = ["ë‚˜ ì•ˆë§ˆì…”!", "ë‚˜ ëŒ€ì‹  ë§ˆì…”", "ë‹¤ìŒ íŒ ì£¼ì‚¬ìœ„ +2", "ê²Œì„ ë©´ì œê¶Œ", "ë©´ì œê¶Œ"];
        const publicKeys = ["ì§€ê¸ˆ ë‹¹ì¥ ë‚˜ë§Œ ë§ˆì…”", "ì „ì› ë§ˆì‹œê¸°", "ëª¨ë‘ ë‚˜ì—ê²Œ ì¡´ëŒ“ë§", "ğŸš« í›ˆë¯¼ì •ìŒ (ì˜ì–´ ê¸ˆì§€)", "ğŸ“µ í•¸ë“œí° ì••ìˆ˜", "ğŸ± ë§ëë§ˆë‹¤ 'ëƒ¥'", "âœ‹ ì™¼ì†ìœ¼ë¡œë§Œ ë§ˆì‹œê¸°"];
        const allKeys = [...privateKeys, ...publicKeys];

        function join(c) {
            const n = document.getElementById('nameInput').value;
            if(!n) return alert("ì´ë¦„ ì…ë ¥!");
            myId = Date.now() + "_" + n;
            db.ref('players/' + myId).set({ name: n, char: c, pos: 0, time: Date.now(), action: "" });
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            document.getElementById('myDisplay').innerText = c + " " + n + "ë‹˜";
        }

        db.ref('players').on('value', s => {
            const ps = s.val();
            playerList = ps ? Object.keys(ps).map(k=>({key:k, ...ps[k]})).sort((a,b)=>a.time - b.time) : [];
        });

        db.ref('turn').on('value', s => {
            const tId = s.val();
            const btn = document.getElementById('rollBtn');
            const status = document.getElementById('status');
            if(!tId && playerList.length > 0) db.ref('turn').set(playerList[0].key);
            btn.disabled = (tId !== myId);
            status.innerText = (tId === myId) ? "ğŸ”” ë‹¹ì‹ ì˜ ì°¨ë¡€!" : "ëŒ€ê¸° ì¤‘...";
            status.style.color = (tId === myId) ? "red" : "#555";
        });

        db.ref('suddenDeath').on('value', s => {
            const d = s.val();
            const ov = document.getElementById('alertOverlay');
            if(d) {
                document.getElementById('alertTitle').innerText = "ğŸš¨ ì„œë“ ë°ìŠ¤ ë°œë™! ğŸš¨";
                document.getElementById('alertText').innerText = d.text;
                ov.style.display = 'flex';
                if(navigator.vibrate) navigator.vibrate([500,200,500]);
            } else { ov.style.display = 'none'; }
        });

        db.ref('miniGameAlert').on('value', s => {
            const al = s.val();
            if(al && al[myId]) {
                document.getElementById('alertTitle').innerText = "âš”ï¸ ë¯¸ë‹ˆê²Œì„ ë°œë™! âš”ï¸";
                document.getElementById('alertText').innerText = "TVì˜ ë£°ë ›ì„ í™•ì¸í•˜ì„¸ìš”!";
                document.getElementById('alertOverlay').style.display = 'flex';
            } else if (!document.getElementById('alertTitle').innerText.includes("ì„œë“ ë°ìŠ¤")) {
                document.getElementById('alertOverlay').style.display = 'none';
            }
        });

        function roll() {
            const dice = Math.floor(Math.random() * 6) + 1;
            currentPos = (currentPos + dice) % 28;
            
            let action = "";
            const penalties = ["ì‹œì‘!", "í•œì” ë§ˆì…”", "ì˜†ì‚¬ëŒ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ğŸ®ëœë¤ê²Œì„", "íŒ¨ìŠ¤~", "ì±Œë¦°ì§€ ë…¸ë˜ì¶”ê¸°", "21í•™ë²ˆ ë§ˆì…”", "ë‘ì” ë§ˆì…”", "ëª¨ë‘ ë§ˆì…”", "í•œ í„´ í• ë¨¸ë‹ˆ", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ë’¤ë¡œ í•œì¹¸", "ëˆ„êµ¬ ë§ˆì…”", "ì˜†ì‚¬ëŒ ë§ˆì…”", "ë‚˜ë§Œ ë¹¼ê³  ë§ˆì…”", "ë„ˆë§Œ ë¹¼ê³  ë§ˆì…”", "23í•™ë²ˆ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ğŸ®ëœë¤ê²Œì„", "íŒ¨ìŠ¤~", "ë²Œì£¼ ë§ˆì…”~", "í•œ í„´ ê³ ì–‘ì´", "ê°™ì´ ë§ˆì…”~", "ëª¨ë‘ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "í•œ ì” ë§ˆì…”", "ë„ì°©ê¸°ë… ë§ˆì…”~"];
            const pText = penalties[currentPos];

            if(pText.includes("í™©ê¸ˆì—´ì‡ ")) {
                const key = allKeys[Math.floor(Math.random() * allKeys.length)];
                action = publicKeys.includes(key) ? key : "SECRET";
                // í° í™”ë©´ì— í‘œì‹œ
                document.getElementById('storageText').innerText = key;
                document.getElementById('goldenKeyStorage').style.display = 'block';
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }
            
            document.getElementById('penaltyLog').innerText = pText;
            db.ref('players/' + myId).update({ pos: currentPos, action: action });
            
            const myIdx = playerList.findIndex(p => p.key === myId);
            db.ref('turn').set(playerList[(myIdx + 1) % playerList.length].key);
        }

        function closeKey() {
            document.getElementById('goldenKeyStorage').style.display = 'none';
        }
    </script>
</body>
</html>