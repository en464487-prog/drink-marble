<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì£¼ë£¨ ë§ˆë¸” - CONTROLLER V18</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; user-select: none; text-align: center; color: #333; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .char-btn { font-size: 30px; padding: 15px 0; border: none; background: white; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .char-btn.selected { background: #e3f2fd; border: 2px solid #2196f3; }
        input, select { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
        .main-btn { width: 100%; padding: 15px; border-radius: 15px; border: none; font-size: 18px; font-weight: bold; color: white; cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
        .btn-blue { background: #2196f3; } .btn-red { background: #ff4757; } .btn-gold { background: #f1c40f; color: black; } .btn-purple { background: #8e44ad; } .btn-green { background: #2ed573; }
        .dice-btn { width: 120px; height: 120px; font-size: 50px; border-radius: 50%; background: linear-gradient(135deg, #ff6b6b, #ee5253); color: white; border: none; box-shadow: 0 10px 20px rgba(238, 82, 83, 0.4); margin: 20px auto; display: block; }
        .dice-btn:disabled { background: #ccc; box-shadow: none; }
        
        /* ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .popup { background: white; padding: 25px; border-radius: 25px; width: 100%; max-width: 350px; text-align: center; max-height: 80vh; overflow-y: auto; }
        .player-select-btn { width: 100%; padding: 12px; margin-bottom: 8px; background: #dfe6e9; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: #333; }
        
        #spyPanel { display: none; background: #2d3436; color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #00cec9; }
        #reportBtn { position: fixed; top: 10px; right: 10px; background: #d63031; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; z-index: 100; opacity: 0.8; }
    </style>
</head>
<body>
    <div id="alertOverlay" class="overlay"><div class="popup"><h2 id="alertTitle"></h2><p id="alertText"></p><button class="main-btn btn-blue" onclick="closeAlert()">í™•ì¸</button></div></div>
    
    <div id="playerSelectOverlay" class="overlay">
        <div class="popup">
            <h2 id="selectTitle">ëŒ€ìƒ ì„ íƒ</h2>
            <div id="playerListArea"></div>
            <button class="main-btn btn-red" onclick="closeSelect()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="ruleInputOverlay" class="overlay">
        <div class="popup">
            <h2>ğŸ“œ ìƒˆë¡œìš´ ë£° ë§Œë“¤ê¸°</h2>
            <input type="text" id="newRuleInput" placeholder="ì˜ˆ: ì›ƒìœ¼ë©´ í•œ ì”">
            <button class="main-btn btn-gold" onclick="confirmRule()">ì„ í¬í•˜ê¸°</button>
            <button class="main-btn btn-red" onclick="document.getElementById('ruleInputOverlay').style.display='none'">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="devilSelectOverlay" class="overlay">
        <div class="popup">
            <h2 style="color:#8e44ad">ğŸ˜ˆ ê±°ë˜ íš¨ê³¼ ì„ íƒ</h2>
            <button class="main-btn btn-blue" onclick="execDevil(1)">1. 1í„´ ê¸ˆì£¼ (ë‚˜)</button>
            <button class="main-btn btn-red" onclick="execDevil(2)">2. ë„ˆ ë§ˆì…” (5íšŒ)</button>
            <button class="main-btn btn-gold" onclick="execDevil(3)">3. ë£° ë©”ì´ì»¤</button>
            <button class="main-btn btn-purple" onclick="execDevil(4)">4. í‘ê¸°ì‚¬ ì§€ëª©</button>
            <p style="font-size:12px; color:#666;">*1í„´ ë‚´ ë¯¸ì‚¬ìš© ì‹œ ì†Œë©¸</p>
        </div>
    </div>

    <div id="voteOverlay" class="overlay"><div class="popup"><h2 id="voteTarget">ì‹¬íŒì˜ ì‹œê°„</h2><button class="main-btn btn-green" onclick="castVote('save')">ğŸ˜‡ ì‚´ë ¤ì¤€ë‹¤</button><button class="main-btn btn-red" onclick="castVote('kill')">ğŸ’€ ë¨¹ì¸ë‹¤</button></div></div>
    <div id="reportOverlay" class="overlay"><div class="popup"><h2>ğŸ•µï¸ ìŠ¤íŒŒì´ ì‹ ê³ </h2><div id="suspectList"></div><button class="main-btn btn-blue" onclick="closeReport()">ì·¨ì†Œ</button></div></div>

    <div id="setup">
        <h1 style="color:#ff4757">ğŸº ì£¼ë£¨ ë§ˆë¸”</h1>
        <div class="card">
            <input type="text" id="nameInput" placeholder="ì´ë¦„ (4ê¸€ì)" maxlength="4">
            <select id="studentIdInput"><option value="none">í•™ë²ˆ ì„ íƒ (í•´ë‹¹ ì—†ìŒ)</option><option value="21">21í•™ë²ˆ</option><option value="23">23í•™ë²ˆ</option></select>
            <div class="char-grid"><div class="char-btn" onclick="selChar('ğŸº')">ğŸº</div><div class="char-btn" onclick="selChar('ğŸ”¥')">ğŸ”¥</div><div class="char-btn" onclick="selChar('ğŸ˜')">ğŸ˜</div><div class="char-btn" onclick="selChar('ğŸ¶')">ğŸ¶</div><div class="char-btn" onclick="selChar('ğŸ¤¢')">ğŸ¤¢</div><div class="char-btn" onclick="selChar('ğŸ‘»')">ğŸ‘»</div></div>
            <button class="main-btn btn-red" onclick="join()">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="game" style="display:none;">
        <button id="reportBtn" onclick="openReport()">ğŸš¨ ì‹ ê³ </button>
        <div id="spyPanel"><h3>ğŸ•µï¸ ë‹¹ì‹ ì€ ìŠ¤íŒŒì´!</h3><p id="spyMissionText" style="color:#81ecec;"></p><button class="main-btn btn-green" onclick="completeSpy()">âœ… ë¯¸ì…˜ ì™„ë£Œ</button></div>
        <div id="bombAlert" style="display:none; background:#ffebee; padding:10px; border-radius:10px; border:2px solid red; color:red; margin-bottom:10px;">ğŸ’£ í­íƒ„ ë³´ìœ  ì¤‘!</div>
        <h2 id="myInfo"></h2>
        
        <button id="uDrinkBtn" class="main-btn btn-red" style="display:none;" onclick="initUDrink()">ğŸ‘‰ ë„ˆ ë§ˆì…”! (<span id="uDrinkCount">5</span>)</button>

        <div id="goldenKeyStorage" style="display:none; background:#fff9c4; padding:15px; border-radius:15px; margin-bottom:15px;"><p id="storageText" style="font-weight:bold; margin:0;"></p></div>
        
        <button id="rollBtn" class="dice-btn" onclick="roll()">ğŸ²</button>
        <button id="trialBtn" class="main-btn btn-gold" style="display:none;" onclick="requestTrial()">âš–ï¸ ë³€ë¡  (1íšŒ)</button>
        <h3 id="status" style="color:#777;">ëŒ€ê¸° ì¤‘...</h3>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://jurumable-9fdde-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId, myName, myChar, myStudentId, playerList = [];
        let currentPos = 0, consecutiveDrinks = 0, devilEffect = null, uDrinkLeft = 0;
        
        const privateKeys = ["ğŸ›¡ï¸ ë¬´ì  ë°©ì–´ê¶Œ", "ğŸ”« ì €ê²©ìˆ˜", "ğŸ‘» ë¬¼ê·€ì‹ ", "ğŸ² ë”ë¸”", "ğŸ”„ ë°˜ì‚¬", "ğŸ¤« í‘ê¸°ì‚¬"];
        const publicKeys = ["ğŸ“œ í›ˆë¯¼ì •ìŒ", "ğŸŒŠ íŒŒë„íƒ€ê¸°", "ğŸ—£ï¸ ì•¼ìíƒ€ì„", "ğŸ“µ í° ê¸ˆì§€", "â¤ï¸ ëŸ¬ë¸Œìƒ·"];
        let selectedChar = "";
        function selChar(c) { selectedChar = c; document.querySelectorAll('.char-btn').forEach(b=>b.classList.remove('selected')); event.target.classList.add('selected'); }

        function join() {
            const n = document.getElementById('nameInput').value;
            const sid = document.getElementById('studentIdInput').value;
            if(!n || !selectedChar) return alert("ì…ë ¥ í™•ì¸!");
            myId = Date.now() + "_" + n; myName = n; myChar = selectedChar; myStudentId = sid;
            db.ref('players/' + myId).set({ name: n, char: selectedChar, studentId: sid, pos: 0, drinkCount: 0, time: Date.now(), isSpy: false });
            document.getElementById('setup').style.display='none'; document.getElementById('game').style.display='block';
            document.getElementById('myInfo').innerText = `${myChar} ${myName} (${sid==='none'?'':sid+'í•™ë²ˆ'})`;
            db.ref('players').once('value', s => { if (s.numChildren() === 1) db.ref('turn').set(myId); });
        }

        db.ref('players').on('value', s => {
            const ps = s.val(); if(!ps) return;
            playerList = Object.keys(ps).map(k=>({key:k, ...ps[k]})).sort((a,b)=>a.time - b.time);
            const me = ps[myId];
            if(me && me.isSpy) { document.getElementById('spyPanel').style.display='block'; document.getElementById('spyMissionText').innerText=me.spyMission; document.getElementById('reportBtn').style.display='none'; }
            else { document.getElementById('spyPanel').style.display='none'; document.getElementById('reportBtn').style.display='block'; }

            // â˜… [ë³´ê°•] ìŠ¤íŒŒì´ ì„±ê³µ/ê²€ê±° ì‹œ ì „ì²´ ì•Œë¦¼ ë° ìë™ ìŒì£¼ ì²˜ë¦¬
            Object.values(ps).forEach(p => {
                if(p.spySuccess) {
                    // ìŠ¤íŒŒì´ê°€ ì„±ê³µí•¨ -> ë‚˜ëŠ” ìŠ¤íŒŒì´ê°€ ì•„ë‹ˆë¼ë©´ ë§ˆì‹ ë‹¤
                    if(!me.isSpy) {
                        if(!localStorage.getItem('spy_punished_' + p.time)) { // ì¤‘ë³µ ìŒì£¼ ë°©ì§€
                            db.ref('players/' + myId + '/drinkCount').transaction(c=>(c||0)+1);
                            showAlert("ğŸ•µï¸ ìŠ¤íŒŒì´ ì„±ê³µ!", `${p.name}ë‹˜ì´ ë¯¸ì…˜ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.<br>ë‚˜ë¨¸ì§€ ì „ì› 1ì”!`, "", "theme-red");
                            localStorage.setItem('spy_punished_' + p.time, 'yes'); // ì²˜ë¦¬ ì™„ë£Œ í‘œì‹œ
                        }
                    }
                }
                if(p.spyCaught) {
                    // ìŠ¤íŒŒì´ê°€ ì¡í˜ -> ìŠ¤íŒŒì´ ë³¸ì¸ë§Œ ë§ˆì‹¬ (ì´ë¯¸ reportì—ì„œ ì²˜ë¦¬ë¨, ì—¬ê¸°ì„  ì•Œë¦¼ë§Œ)
                    if(me.isSpy) { // ë‚´ê°€ ìŠ¤íŒŒì´ì˜€ë‹¤ë©´
                         showAlert("ğŸ‘® ê²€ê±°ë¨!", "ë‹¹ì‹ ì€ ë°œê°ë˜ì—ˆìŠµë‹ˆë‹¤. ë²Œì£¼ 1ì”!", "", "theme-red");
                    }
                }
            });
        });

        // ì§€ëª© ì•Œë¦¼ (ê°œì¸ í°)
        db.ref('devilTarget').on('value', s => {
            const t = s.val();
            if(t && t.targetKey === myId) {
                showAlert("ğŸ˜ˆ ì§€ëª© ë‹¹í•¨!", `<span style='color:red; font-size:24px;'>${t.sender}</span>ë‹˜ì´ ë‹¹ì‹ ì„ ì§€ëª©í–ˆìŠµë‹ˆë‹¤!<br>${t.msg}`, "", "theme-red");
                if(navigator.vibrate) navigator.vibrate([500,200,500]);
            }
        });

        // í”Œë ˆì´ì–´ ì„ íƒ UI
        function openPlayerSelect(title, callbackName) {
            document.getElementById('selectTitle').innerText = title;
            const area = document.getElementById('playerListArea'); area.innerHTML = "";
            playerList.forEach(p => { if(p.key !== myId) area.innerHTML += `<button class="player-select-btn" onclick="${callbackName}('${p.key}', '${p.name}')">${p.name}</button>`; });
            document.getElementById('playerSelectOverlay').style.display = 'flex';
        }
        function closeSelect() { document.getElementById('playerSelectOverlay').style.display = 'none'; }

        // ì•…ë§ˆì˜ ê±°ë˜ ë¡œì§
        function triggerDevilDeal() { document.getElementById('devilSelectOverlay').style.display = 'flex'; }
        function execDevil(type) {
            document.getElementById('devilSelectOverlay').style.display = 'none';
            if(type === 1) { // 1í„´ ê¸ˆì£¼
                devilEffect = "no_drink";
                db.ref('devilDeal').set({ type: 'SELF', user: myName, effect: "ì´ë²ˆ í„´ ì ˆëŒ€ ê¸ˆì£¼ ì„ ì–¸!" });
                alert("ì´ë²ˆ í„´ ë¬´ì ì…ë‹ˆë‹¤.");
            } else if(type === 2) { // ë„ˆ ë§ˆì…” 5íšŒ
                uDrinkLeft = 5;
                document.getElementById('uDrinkBtn').style.display = 'block';
                document.getElementById('uDrinkCount').innerText = 5;
                db.ref('devilDeal').set({ type: 'SELF', user: myName, effect: "ğŸ‘‰ 'ë„ˆ ë§ˆì…”' ê¶Œí•œ(5íšŒ) íšë“!" });
            } else if(type === 3) { // ë£° ë©”ì´ì»¤
                document.getElementById('ruleInputOverlay').style.display = 'flex';
            } else if(type === 4) { // í‘ê¸°ì‚¬
                openPlayerSelect("ëŒ€ì‹  ë§ˆì‹¤ ì‚¬ëŒ ì§€ëª©", "confirmSubstitute");
            }
        }

        // ë£° ë©”ì´ì»¤
        function confirmRule() {
            const rule = document.getElementById('newRuleInput').value;
            if(!rule) return alert("ë‚´ìš© ì…ë ¥!");
            db.ref('activeRule').set(rule);
            db.ref('devilDeal').set({ type: 'RULE', user: myName, content: rule });
            document.getElementById('ruleInputOverlay').style.display = 'none';
        }

        // í‘ê¸°ì‚¬ ì§€ëª©
        function confirmSubstitute(key, name) {
            db.ref('substituteDrinker').set({ from: myId, to: key });
            db.ref('devilDeal').set({ type: 'TARGET', user: myName, target: name, effect: "ëŒ€ë¦¬ ìŒì£¼ìë¡œ ì§€ëª…ë¨" });
            db.ref('devilTarget').set({ targetKey: key, sender: myName, msg: "í‘ê¸°ì‚¬ë¡œ ì§€ëª©ë˜ì—ˆìŠµë‹ˆë‹¤." });
            closeSelect();
        }

        // ë„ˆ ë§ˆì…” ì‚¬ìš©
        function initUDrink() { if(uDrinkLeft > 0) openPlayerSelect("ë¨¹ì¼ ì‚¬ëŒ ì„ íƒ", "confirmUDrink"); }
        function confirmUDrink(key, name) {
            db.ref('players/'+key+'/drinkCount').transaction(c=>(c||0)+1);
            uDrinkLeft--;
            document.getElementById('uDrinkCount').innerText = uDrinkLeft;
            if(uDrinkLeft === 0) document.getElementById('uDrinkBtn').style.display = 'none';
            
            // â˜… [ë³´ê°•] TVì—ë„ ì•Œë¦¼ ì „ì†¡ + íƒ€ê²Ÿ í°ì—ë„ ì•Œë¦¼
            db.ref('devilDeal').set({ type: 'TARGET', user: myName, target: name, effect: "ğŸ‘‰ ë„ˆ ë§ˆì…”! ê³µê²© ì‹œì „ (1ì”)" });
            db.ref('devilTarget').set({ targetKey: key, sender: myName, msg: "ì§€ëª© ë‹¹í–ˆìŠµë‹ˆë‹¤. 1ì” ë§ˆì‹œì„¸ìš”!" });
            
            alert(name + "ì—ê²Œ ë¨¹ì˜€ìŠµë‹ˆë‹¤!");
            closeSelect();
        }

        // ìŠ¤íŒŒì´ ë¡œì§
        function completeSpy() {
            db.ref('players/' + myId + '/spySuccess').set(true); // ì „ì²´ ì•Œë¦¼ íŠ¸ë¦¬ê±°
            db.ref('players/' + myId).update({ isSpy: false, spyMission: null });
            alert("ë¯¸ì…˜ ì„±ê³µ! ë‚˜ ë¹¼ê³  ë‹¤ ë§ˆì‹­ë‹ˆë‹¤ ^^");
        }
        function openReport() {
            const list = document.getElementById('suspectList'); list.innerHTML = "";
            playerList.forEach(p => { if(p.key !== myId) list.innerHTML += `<button class="main-btn btn-blue" onclick="doReport('${p.key}')">${p.name}</button>`; });
            document.getElementById('reportOverlay').style.display = 'flex';
        }
        function doReport(k) {
            const t = playerList.find(p => p.key === k);
            if(t.isSpy) {
                db.ref('players/' + k + '/spyCaught').set(true);
                db.ref('players/' + k).update({ isSpy: false, spyMission: null });
                db.ref('players/' + k + '/drinkCount').transaction(c => (c||0)+1); // ìŠ¤íŒŒì´ ë²Œì£¼
                alert("ê²€ê±° ì„±ê³µ!");
            } else {
                db.ref('players/' + myId + '/drinkCount').transaction(c => (c||0)+1); // ë¬´ê³  ë²Œì£¼
                alert("í‹€ë ¸ìŠµë‹ˆë‹¤! ë‹¹ì‹ ì´ ë§ˆì‹­ë‹ˆë‹¤.");
            }
            closeReport();
        }
        function closeReport() { document.getElementById('reportOverlay').style.display='none'; }

        // ì£¼ì‚¬ìœ„ ë° ê²Œì„ ë¡œì§
        function roll() {
            // 1í„´ ì œí•œ: ë¯¸ì‚¬ìš© ë„ˆ ë§ˆì…” ë²„íŠ¼ ì œê±°
            if(uDrinkLeft > 0 && document.getElementById('uDrinkBtn').style.display === 'block') {
                document.getElementById('uDrinkBtn').style.display = 'none';
                uDrinkLeft = 0;
            }
            // 1í„´ ì œí•œ: ê¸ˆì£¼ íš¨ê³¼ í•´ì œ (ì‚¬ìš© í›„ ë‹¤ìŒ í„´ì´ ì˜¤ë©´ í•´ì œ) - ì—¬ê¸°ì„œ ë¦¬ì…‹í•˜ë©´ íš¨ê³¼ ëª» ë´„. 
            // ë¡œì§ ìˆ˜ì •: ë§ˆì…”ì•¼ í•  ë•Œ íš¨ê³¼ ì²´í¬ í›„ ë¦¬ì…‹í•˜ëŠ” ë°©ì‹ (ì•„ë˜ì— êµ¬í˜„ë¨)

            let dice = Math.floor(Math.random() * 6) + 1;
            const minDrink = Math.min(...playerList.map(p => p.drinkCount || 0));
            const myDrink = playerList.find(p=>p.key===myId).drinkCount || 0;
            
            // ë°¸ëŸ°ìŠ¤ ë¡œì§
            if((consecutiveDrinks >= 3 || myDrink > minDrink + 10)) {
                 const badKeywords = ["ë§ˆì…”", "í­íƒ„"];
                 const penalties = ["ì‹œì‘!", "í•œì” ë§ˆì…”", "ì˜†ì‚¬ëŒ ë§ˆì…”", "ğŸ’£í­íƒ„ íšë“", "ğŸ®ëœë¤ê²Œì„", "íŒ¨ìŠ¤~", "ì±Œë¦°ì§€ ë…¸ë˜ì¶”ê¸°", "21í•™ë²ˆ ë§ˆì…”", "ë‘ì” ë§ˆì…”", "ëª¨ë‘ ë§ˆì…”", "í•œ í„´ í• ë¨¸ë‹ˆ", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ğŸ’£í­íƒ„ íšë“", "ëˆ„êµ¬ ë§ˆì…”", "ì˜†ì‚¬ëŒ ë§ˆì…”", "ë‚˜ë§Œ ë¹¼ê³  ë§ˆì…”", "ë„ˆë§Œ ë¹¼ê³  ë§ˆì…”", "23í•™ë²ˆ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ğŸ®ëœë¤ê²Œì„", "íŒ¨ìŠ¤~", "ë²Œì£¼ ë§ˆì…”~", "í•œ í„´ ê³ ì–‘ì´", "ê°™ì´ ë§ˆì…”~", "ëª¨ë‘ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "í•œ ì” ë§ˆì…”", "ë„ì°©ê¸°ë… ë§ˆì…”~"];
                 for(let i=0; i<5; i++) {
                    let tempPos = (currentPos + dice) % 28;
                    if(badKeywords.some(bad => penalties[tempPos].includes(bad))) dice = Math.floor(Math.random() * 6) + 1;
                    else break;
                }
                showAlert("âš–ï¸ ë°¸ëŸ°ìŠ¤ ë³´í˜¸", "ì‹œìŠ¤í…œì´ ë‹¹ì‹ ì„ ë•ìŠµë‹ˆë‹¤.", "", "theme-blue");
                consecutiveDrinks = 0;
            }

            const oldPos = currentPos;
            currentPos = (currentPos + dice) % 28;
            const penalties = ["ì‹œì‘!", "í•œì” ë§ˆì…”", "ì˜†ì‚¬ëŒ ë§ˆì…”", "ğŸ’£í­íƒ„ íšë“", "ğŸ®ëœë¤ê²Œì„", "íŒ¨ìŠ¤~", "ì±Œë¦°ì§€ ë…¸ë˜ì¶”ê¸°", "21í•™ë²ˆ ë§ˆì…”", "ë‘ì” ë§ˆì…”", "ëª¨ë‘ ë§ˆì…”", "í•œ í„´ í• ë¨¸ë‹ˆ", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ğŸ’£í­íƒ„ íšë“", "ëˆ„êµ¬ ë§ˆì…”", "ì˜†ì‚¬ëŒ ë§ˆì…”", "ë‚˜ë§Œ ë¹¼ê³  ë§ˆì…”", "ë„ˆë§Œ ë¹¼ê³  ë§ˆì…”", "23í•™ë²ˆ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ğŸ®ëœë¤ê²Œì„", "íŒ¨ìŠ¤~", "ë²Œì£¼ ë§ˆì…”~", "í•œ í„´ ê³ ì–‘ì´", "ê°™ì´ ë§ˆì…”~", "ëª¨ë‘ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "í•œ ì” ë§ˆì…”", "ë„ì°©ê¸°ë… ë§ˆì…”~"];
            const currentCell = penalties[currentPos];
            let action = "";

            if (currentCell.includes("ë§ˆì…”")) {
                let shouldDrink = true;
                if(currentCell.includes("21í•™ë²ˆ") && myStudentId !== '21') shouldDrink = false;
                if(currentCell.includes("23í•™ë²ˆ") && myStudentId !== '23') shouldDrink = false;
                
                // ê¸ˆì£¼ íš¨ê³¼ ì²´í¬ (1íšŒìš©)
                if(devilEffect === "no_drink") { shouldDrink = false; devilEffect = null; showAlert("ğŸ˜ˆ ê¸ˆì£¼ íš¨ê³¼", "ìˆ ì„ ë§ˆì‹œì§€ ì•ŠìŠµë‹ˆë‹¤.", "", "theme-purple"); }

                if(shouldDrink) {
                    db.ref('substituteDrinker').once('value', s => {
                        const sub = s.val();
                        if(sub && sub.from === myId) { // ë‚´ê°€ í‘ê¸°ì‚¬ë¥¼ ì¼ë‹¤ë©´
                            db.ref('players/' + sub.to + '/drinkCount').transaction(c => (c||0)+1); // ê·¸ ì‚¬ëŒì´ ë§ˆì‹¬
                            alert("ëŒ€ë¦¬ ìŒì£¼ìê°€ ëŒ€ì‹  ë§ˆì‹­ë‹ˆë‹¤!");
                            db.ref('substituteDrinker').remove();
                        } else {
                            db.ref('players/' + myId + '/drinkCount').transaction(c => (c || 0) + 1);
                            consecutiveDrinks++;
                            document.getElementById('trialBtn').style.display = 'block';
                        }
                    });
                } else { consecutiveDrinks = 0; }
            } else { consecutiveDrinks = 0; document.getElementById('trialBtn').style.display = 'none'; }

            // í­íƒ„ ì¶”ì›”
            db.ref('bomb').once('value', s => {
                const b = s.val();
                if (b && b.owner === myId) {
                    let victim = null;
                    for (let i = 1; i <= dice; i++) {
                        const targets = playerList.filter(p => p.pos === (oldPos + i) % 28 && p.key !== myId);
                        if (targets.length > 0) victim = targets[0];
                    }
                    if (victim) { db.ref('bomb/owner').set(victim.key); showAlert("ğŸ’£ í­íƒ„ ë°°ë‹¬!", `${victim.name}ë‹˜ê»˜ ë„˜ê²¼ìŠµë‹ˆë‹¤!`, "", "theme-blue"); }
                }
            });

            if (currentCell.includes("í­íƒ„")) { db.ref('bomb').set({ owner: myId, timer: playerList.length * 3 }); showAlert("ğŸ’£ í­íƒ„ íšë“!", "ì‹œí•œí­íƒ„ ì‘ë™!", "", "theme-red"); } 
            else db.ref('bomb').transaction(b => b ? { ...b, timer: b.timer - 1 } : b);

            if(currentCell.includes("í™©ê¸ˆì—´ì‡ ")) {
                if(Math.random() < 0.2) triggerDevilDeal();
                else {
                    const key = [...privateKeys, ...publicKeys][Math.floor(Math.random() * (privateKeys.length + publicKeys.length))];
                    action = privateKeys.includes(key) ? "SECRET" : key;
                    document.getElementById('storageText').innerText = key;
                    document.getElementById('goldenKeyStorage').style.display = 'block';
                }
            }
            if(currentCell.includes("ëœë¤ê²Œì„")) db.ref('slotTrigger').set(true);

            db.ref('players/' + myId).update({ pos: currentPos, action: action });
            const nextIdx = (playerList.findIndex(p => p.key === myId) + 1) % playerList.length;
            db.ref('turn').set(playerList[nextIdx].key);
        }

        // ìµœí›„ì˜ ë³€ë¡ 
        function requestTrial() { db.ref('currentTrial').set({ defender: myId, name: myName }); db.ref('votes').remove(); document.getElementById('trialBtn').style.display = 'none'; }
        db.ref('currentTrial').on('value', s => { const t = s.val(); if(t && t.defender !== myId) document.getElementById('voteOverlay').style.display = 'flex'; else document.getElementById('voteOverlay').style.display = 'none'; });
        function castVote(type) { db.ref('votes/' + myId).set(type); document.getElementById('voteOverlay').style.display = 'none'; }
        
        function showAlert(t, tx, st, th) { document.getElementById('alertTitle').innerText = t; document.getElementById('alertText').innerHTML = tx; document.getElementById('alertOverlay').style.display = 'flex'; }
        function closeAlert() { document.getElementById('alertOverlay').style.display = 'none'; }
    </script>
</body>
</html>