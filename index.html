<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°”ì´ë¯¼ ë§ˆë¸” ì»¨íŠ¸ë¡¤ëŸ¬</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { text-align: center; font-family: 'Apple SD Gothic Neo', sans-serif; background: #f4f4f4; padding: 20px; margin: 0; }
        
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 400px; margin: 0 auto; }
        .char-btn { 
            font-size: 35px; height: 80px; 
            border: 2px solid #ddd; background: white; border-radius: 15px; 
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px #ccc;
        }
        .char-btn:active { box-shadow: 0 0 #ccc; transform: translateY(4px); background: #fff5f5; }
        
        #nameModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 20px; width: 80%; max-width: 300px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
        }
        #modalCharIcon { font-size: 50px; display: block; margin-bottom: 10px; }
        #nameInput { 
            font-size: 18px; padding: 10px; width: 80%; margin-bottom: 15px; 
            border: 2px solid #333; border-radius: 8px; text-align: center; 
        }
        .confirm-btn {
            background: #ff4757; color: white; border: none; padding: 12px 30px; 
            font-size: 18px; border-radius: 10px; cursor: pointer; width: 100%;
        }

        #play { display: none; }
        
        /* [ìˆ˜ì •ë¨] ì£¼ì‚¬ìœ„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (í™œì„±/ë¹„í™œì„±) */
        .dice-btn { width: 140px; height: 140px; font-size: 50px; border-radius: 50%; border: none; background: #ff4757; color: white; box-shadow: 0 8px #d63031; cursor: pointer; margin-top: 30px; transition: 0.3s; }
        .dice-btn:active { box-shadow: 0 2px #d63031; transform: translateY(4px); }
        
        /* ë¹„í™œì„± ìƒíƒœ (íšŒìƒ‰) */
        .dice-btn.disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; transform: translateY(4px); opacity: 0.5; }
        
        #penaltyBox { min-height: 80px; background: white; border-radius: 15px; display: flex; align-items: center; justify-content: center; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 30px; }
        
        #goldenKeyStorage { 
            display: none; margin-top: 20px; padding: 15px; 
            background: #fff9c4; border: 3px dashed gold; border-radius: 15px; 
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
            animation: pop 0.3s ease-out;
        }
        .use-btn { background: #333; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; margin-top: 10px; }
        
        /* [NEW] í„´ ì•ˆë‚´ ë©”ì‹œì§€ */
        #turnMsg { font-size: 16px; color: #555; margin-top: 10px; font-weight: bold; }

        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="login">
        <h2 style="margin-bottom: 20px;">ë‚´ ìºë¦­í„° ê³ ë¥´ê¸°</h2>
        <p style="color:#666; font-size:14px; margin-bottom:30px;">ì›í•˜ëŠ” ê±¸ ëˆ„ë¥´ê³  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!</p>
        <div class="char-grid">
            <button class="char-btn" onclick="openNameModal('ğŸº')">ğŸº</button>
            <button class="char-btn" onclick="openNameModal('ğŸ¶')">ğŸ¶</button>
            <button class="char-btn" onclick="openNameModal('ğŸ·')">ğŸ·</button>
            <button class="char-btn" onclick="openNameModal('ğŸ¹')">ğŸ¹</button>
            <button class="char-btn" onclick="openNameModal('ğŸ”¥')">ğŸ”¥</button>
            <button class="char-btn" onclick="openNameModal('ğŸ¤¢')">ğŸ¤¢</button>
            <button class="char-btn" onclick="openNameModal('ğŸ˜')">ğŸ˜</button>
            <button class="char-btn" onclick="openNameModal('ğŸ‘»')">ğŸ‘»</button>
            <button class="char-btn" onclick="openNameModal('ğŸ’©')">ğŸ’©</button>
        </div>
    </div>

    <div id="nameModal">
        <div class="modal-content">
            <span id="modalCharIcon">ğŸº</span>
            <h3>ì´ë¦„ì„ ì•Œë ¤ì£¼ì„¸ìš”!</h3>
            <input type="text" id="nameInput" placeholder="ì˜ˆ: ë°”ì´ë¯¼" maxlength="4">
            <button class="confirm-btn" onclick="joinGame()">ì…ì¥í•˜ê¸°</button>
            <button onclick="closeModal()" style="background:none; border:none; color:#999; margin-top:10px; cursor:pointer;">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="play">
        <h2 id="myInfo" style="margin: 10px 0;"></h2>
        
        <div id="goldenKeyStorage">
            <div style="color: #f39c12; font-weight: bold; font-size: 14px;">ğŸ”‘ ë³´ìœ  ì¤‘ì¸ í™©ê¸ˆì—´ì‡ </div>
            <div id="storageText" style="font-size: 20px; font-weight: bold; margin: 10px 0;">ë‚´ìš©</div>
            <button class="use-btn" onclick="useKey()">ì‚¬ìš©í•˜ê¸° (ì‚­ì œ)</button>
        </div>

        <div id="turnMsg">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
        <button id="diceBtn" class="dice-btn disabled" onclick="roll()">ğŸ²</button>
        <h1 id="diceNum" style="margin: 10px 0; color:#ff4757;">?</h1>
        
        <div id="penaltyBox">
            <p id="penaltyMsg" style="font-size:22px; font-weight:bold; color:#ff4757; margin:0;">ëŒ€ê¸° ì¤‘...</p>
        </div>
    </div>

    <script>
        // [í•„ìˆ˜] ë³¸ì¸ì˜ íŒŒì´ì–´ë² ì´ìŠ¤ ì£¼ì†Œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
        const firebaseConfig = { databaseURL: "https://jurumable-9fdde-default-rtdb.firebaseio.com/" };
        
        try { firebase.initializeApp(firebaseConfig); } catch(e) {}
        const db = firebase.database();

        const penalties = ["ì‹œì‘!", "í•œì” ë§ˆì…”", "ì˜†ì‚¬ëŒ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ğŸ®ëœë¤ê²Œì„", "íŒ¨ìŠ¤~", "ì±Œë¦°ì§€ ë…¸ë˜ì¶”ê¸°", "21í•™ë²ˆ ë§ˆì…”",
            "ë‘ì” ë§ˆì…”", "ëª¨ë‘ ë§ˆì…”", "í•œ í„´ í• ë¨¸ë‹ˆ", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ë’¤ë¡œ í•œì¹¸", "ëˆ„êµ¬ ë§ˆì…”", "ì˜†ì‚¬ëŒ ë§ˆì…”", "ë‚˜ë§Œ ë¹¼ê³  ë§ˆì…”",
            "ë„ˆë§Œ ë¹¼ê³  ë§ˆì…”", "23í•™ë²ˆ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ğŸ®ëœë¤ê²Œì„", "íŒ¨ìŠ¤~", "ë²Œì£¼ ë§ˆì…”~", "í•œ í„´ ê³ ì–‘ì´", "ê°™ì´ ë§ˆì…”~",
            "ëª¨ë‘ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "í•œ ì” ë§ˆì…”", "ë„ì°©ê¸°ë… ë§ˆì…”~"];
        const goldKeys = ["ë‚˜ ì•ˆë§ˆì…”!", "ë‚˜ ëŒ€ì‹  ë§ˆì…”", "ë‹¤ìŒ íŒ ì£¼ì‚¬ìœ„ +2", "ì§€ê¸ˆ ë‹¹ì¥ ë‚˜ë§Œ ë§ˆì…”", "ì „ì› ë§ˆì‹œê¸°", "ê²Œì„ ë©´ì œê¶Œ", "ë©´ì œê¶Œ", "ëª¨ë‘ ë‚˜ì—ê²Œ ì¡´ëŒ“ë§"];

        let selectedChar = "", myId = "", currentPos = 0;
        let playerList = []; // ìˆœì„œ ê³„ì‚°ìš© ë¦¬ìŠ¤íŠ¸

        // 1. í”Œë ˆì´ì–´ ëª©ë¡ ê°ì§€ (ìˆœì„œ íŒŒì•…ìš©)
        db.ref('players').on('value', (snap) => {
            const players = snap.val();
            if(!players && myId !== "") location.reload(); // ì´ˆê¸°í™” ê°ì§€

            // í”Œë ˆì´ì–´ë¥¼ ì…ì¥ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬í•´ì„œ ë¦¬ìŠ¤íŠ¸ë¡œ ë§Œë“¦
            playerList = [];
            for(let key in players) {
                playerList.push({ key: key, ...players[key] });
            }
            playerList.sort((a, b) => a.time - b.time);
        });

        // 2. í˜„ì¬ í„´(ëˆ„êµ¬ ì°¨ë¡€ì¸ì§€) ê°ì§€
        db.ref('turn').on('value', (snap) => {
            const currentTurnId = snap.val();
            const diceBtn = document.getElementById('diceBtn');
            const turnMsg = document.getElementById('turnMsg');
            const penaltyMsg = document.getElementById('penaltyMsg');

            if (!currentTurnId) return;

            // ë‚´ ì°¨ë¡€ì¸ê°€?
            if (currentTurnId === myId) {
                diceBtn.classList.remove('disabled');
                diceBtn.disabled = false;
                turnMsg.innerText = "ğŸ™Œ ë‚´ ì°¨ë¡€ì…ë‹ˆë‹¤! ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ì„¸ìš”!";
                turnMsg.style.color = "#ff4757";
                if(penaltyMsg.innerText === "ëŒ€ê¸° ì¤‘...") penaltyMsg.innerText = "Go!";
                if(navigator.vibrate) navigator.vibrate(200); // ì§„ë™ ì•Œë¦¼
            } else {
                diceBtn.classList.add('disabled');
                diceBtn.disabled = true;
                
                // ëˆ„êµ¬ ì°¨ë¡€ì¸ì§€ ì´ë¦„ ì°¾ê¸°
                const turnPlayer = playerList.find(p => p.key === currentTurnId);
                const turnName = turnPlayer ? turnPlayer.name : "ëˆ„êµ°ê°€";
                turnMsg.innerText = `â³ ${turnName}ë‹˜ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤...`;
                turnMsg.style.color = "#999";
            }
        });

        function openNameModal(char) {
            selectedChar = char;
            document.getElementById('modalCharIcon').innerText = char;
            document.getElementById('nameModal').style.display = 'flex';
            document.getElementById('nameInput').focus();
        }
        function closeModal() { document.getElementById('nameModal').style.display = 'none'; }

        function joinGame() {
            const name = document.getElementById('nameInput').value;
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            
            myId = Date.now() + "_" + name;
            // ë‚´ ì •ë³´ ì €ì¥
            db.ref('players/' + myId).set({ name, char: selectedChar, pos: 0, time: Date.now() });
            
            closeModal();
            document.getElementById('login').style.display = 'none';
            document.getElementById('play').style.display = 'block';
            document.getElementById('myInfo').innerText = `${selectedChar} ${name}ë‹˜`;
        }

        function roll() {
            if(document.getElementById('diceBtn').disabled) return; // ì–µì§€ë¡œ ëˆ„ë¦„ ë°©ì§€

            const dice = Math.floor(Math.random() * 6) + 1;
            currentPos = (currentPos + dice) % 28;
            
            // 1. ë‚´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            db.ref('players/' + myId).update({ pos: currentPos });
            document.getElementById('diceNum').innerText = dice;
            
            // 2. ë²Œì¹™ ì²˜ë¦¬
            const msg = penalties[currentPos];
            if (msg.includes("ğŸ—ï¸")) {
                const key = goldKeys[Math.floor(Math.random() * goldKeys.length)];
                document.getElementById('storageText').innerText = key;
                document.getElementById('goldenKeyStorage').style.display = 'block';
                document.getElementById('penaltyMsg').innerText = "âœ¨í™©ê¸ˆì—´ì‡  íšë“!";
            } else if (msg.includes("ëœë¤ê²Œì„")) {
                document.getElementById('penaltyMsg').innerHTML = "ğŸ® ëœë¤ê²Œì„!<br>TV í™”ë©´ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!";
            } else {
                document.getElementById('penaltyMsg').innerText = msg;
            }

            // 3. [í•µì‹¬] ë‹¤ìŒ ì‚¬ëŒì—ê²Œ í„´ ë„˜ê¸°ê¸°
            passTurn();
        }

        function passTurn() {
            // í˜„ì¬ ë‚´ ì¸ë±ìŠ¤ ì°¾ê¸°
            const myIndex = playerList.findIndex(p => p.key === myId);
            if (myIndex === -1) return;

            // ë‹¤ìŒ ì‚¬ëŒ ì°¾ê¸° (ë§ˆì§€ë§‰ ì‚¬ëŒì´ë©´ ë‹¤ì‹œ 0ë²ˆìœ¼ë¡œ)
            const nextIndex = (myIndex + 1) % playerList.length;
            const nextPlayerId = playerList[nextIndex].key;

            // ì„œë²„ì— ë‹¤ìŒ í„´ ì €ì¥
            db.ref('turn').set(nextPlayerId);
        }

        function useKey() {
            if(confirm("ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) document.getElementById('goldenKeyStorage').style.display = 'none';
        }
    </script>
</body>
</html>