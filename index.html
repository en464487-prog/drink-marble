<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë£¨ ë§ˆë¸” í”Œë ˆì´ì–´</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { text-align: center; font-family: 'Apple SD Gothic Neo', sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 400px; margin: 20px auto; }
        .char-btn { font-size: 35px; height: 80px; border: 2px solid #ddd; background: white; border-radius: 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px #ccc; cursor: pointer; transition: 0.2s; }
        .char-btn:active { transform: scale(0.95); background: #eee; }
        #nameInput { font-size: 20px; padding: 12px; width: 80%; border: 2px solid #333; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .dice-btn { width: 150px; height: 150px; font-size: 60px; border-radius: 50%; background: #ff4757; color: white; margin-top: 30px; border: 8px solid #d63031; box-shadow: 0 8px #b33939; cursor: pointer; transition: 0.2s; }
        .dice-btn:active { transform: translateY(4px); box-shadow: 0 4px #b33939; }
        .dice-btn:disabled { background: #ccc; border-color: #999; opacity: 0.5; box-shadow: none; cursor: not-allowed; }
        
        #goldenKeyStorage, #randomGameBtnArea { display: none; margin-top: 20px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); animation: slideIn 0.3s; }
        #goldenKeyStorage { background: #fff9c4; border: 4px solid #f1c40f; }
        #randomGameBtnArea { background: #e3f2fd; border: 4px solid #2196f3; }
        
        /* â˜… í­íƒ„ ì•Œë¦¼ì°½ ìŠ¤íƒ€ì¼ (ë²Œì¹™ ë¦¬ìŠ¤íŠ¸ í¬í•¨) */
        #bombAlert { display: none; background: #ffebee; border: 2px solid #ef5350; color: #c62828; padding: 15px; border-radius: 10px; margin-bottom: 15px; font-weight: bold; animation: pulse 1s infinite; text-align: center; }
        
        /* â˜… ì•Œë¦¼ì°½ ì •ì¤‘ì•™ ì •ë ¬ ê°•í™” */
        #alertOverlay { 
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 10000; 
            display: flex; justify-content: center; align-items: center; 
        }
        #alertContent { background: white; color: black; padding: 30px; border-radius: 20px; width: 80%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); margin: auto; }
        #alertTitle { font-size: 28px; margin-bottom: 15px; font-weight: 900; }
        #alertText { font-size: 20px; line-height: 1.4; word-break: keep-all; }
        #alertSubText { font-size: 14px; color: #666; margin-top: 10px; }
        
        .theme-red { background: rgba(220, 20, 60, 0.9) !important; }
        .theme-blue { background: rgba(33, 150, 243, 0.9) !important; }
        .theme-orange { background: rgba(255, 152, 0, 0.9) !important; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="alertOverlay" style="display:none;">
        <div id="alertContent">
            <h1 id="alertTitle">ì•Œë¦¼</h1>
            <p id="alertText"></p>
            <p id="alertSubText"></p>
            <button onclick="document.getElementById('alertOverlay').style.display='none'" style="margin-top:20px; padding:10px 30px; font-size:18px; border:none; background:#333; color:white; border-radius:10px; cursor:pointer;">í™•ì¸</button>
        </div>
    </div>
    <div id="setup">
        <h1 style="color:#ff4757; font-size: 32px; margin-bottom: 10px;">ğŸº ì£¼ë£¨ ë§ˆë¸”</h1>
        <input type="text" id="nameInput" placeholder="ì´ë¦„ (4ì ì´ë‚´)" maxlength="4">
        <div class="char-grid">
            <div class="char-btn" onclick="join('ğŸº')">ğŸº</div><div class="char-btn" onclick="join('ğŸ”¥')">ğŸ”¥</div><div class="char-btn" onclick="join('ğŸ˜')">ğŸ˜</div>
            <div class="char-btn" onclick="join('ğŸ¶')">ğŸ¶</div><div class="char-btn" onclick="join('ğŸ¤¢')">ğŸ¤¢</div><div class="char-btn" onclick="join('ğŸ‘»')">ğŸ‘»</div>
            <div class="char-btn" onclick="join('ğŸ·')">ğŸ·</div><div class="char-btn" onclick="join('ğŸ¹')">ğŸ¹</div><div class="char-btn" onclick="join('ğŸ’©')">ğŸ’©</div>
        </div>
    </div>
    <div id="game" style="display:none;">
        <div id="bombAlert">
            ğŸ’£ ë‹¹ì‹ ì€ í­íƒ„ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤!
        </div>
        <h2 id="myInfo" style="margin-top:0;"></h2>
        <div id="goldenKeyStorage">
            <h3 style="margin:0; color: #d35400;">ğŸƒ íˆë“  ì¹´ë“œ íšë“!</h3>
            <p id="storageText" style="font-size: 20px; font-weight: bold; margin: 15px 0; word-break: keep-all;"></p>
            <button onclick="document.getElementById('goldenKeyStorage').style.display='none'" style="padding:10px 20px; background:#333; color:white; border:none; border-radius:20px;">í™•ì¸ ì™„ë£Œ</button>
        </div>
        <div id="randomGameBtnArea">
            <h3 style="margin:0; color: #1565c0;">ğŸ® ëœë¤ê²Œì„ ë„ì°©!</h3>
            <p style="font-size: 16px; margin: 10px 0;">TV í™”ë©´ì˜ ìŠ¬ë¡¯ë¨¸ì‹ ì„ ëŒë¦¬ì„¸ìš”.</p>
            <button onclick="triggerSlotMachine()" style="padding:15px 30px; background:#2196f3; color:white; border:none; border-radius:20px; font-weight:bold; font-size:18px;">ğŸ° ìŠ¬ë¡¯ ëŒë¦¬ê¸°</button>
        </div>
        <h3 id="status" style="margin-top:30px; font-weight: bold; color: #555;">ëŒ€ê¸° ì¤‘...</h3>
        <button id="rollBtn" class="dice-btn" onclick="roll()">ğŸ²</button>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://jurumable-9fdde-default-rtdb.firebaseio.com/",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId, currentPos = 0, playerList = [];
        const privateKeys = ["ë‚˜ ì•ˆë§ˆì…”!", "ë‚˜ ëŒ€ì‹  ë§ˆì…”", "ë‹¤ìŒ í„´ ì£¼ì‚¬ìœ„ +2", "ê²Œì„ ë©´ì œê¶Œ"]; 
        const publicKeys = ["ì „ì› ë§ˆì‹œê¸°", "ì˜ì–´ ê¸ˆì§€ (í›ˆë¯¼ì •ìŒ)", "í•¸ë“œí° ì••ìˆ˜", "ë§ëë§ˆë‹¤ 'ëƒ¥'", "ì™¼ì†ìœ¼ë¡œë§Œ ë§ˆì‹œê¸°"];
        const allKeys = [...privateKeys, ...publicKeys];
        const bombPenalties = ["ğŸ¥ƒ ì†Œì£¼ í° ì”ì— ì›ìƒ·!", "ğŸ“¸ ì—½ì‚¬ ì°ì–´ ì¸ìŠ¤íƒ€ ì—…ëƒ!", "ğŸ¤« ì§„ì‹¤ or ì°½í”¼í•œ ì¼ ë§í•˜ê¸°"];

        function join(c) {
            const n = document.getElementById('nameInput').value;
            if(!n) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            myId = Date.now() + "_" + n;
            db.ref('players/' + myId).set({ name: n, char: c, pos: 0, time: Date.now(), action: "", drinkCount: 0 });
            document.getElementById('setup').style.display='none';
            document.getElementById('game').style.display='block';
            document.getElementById('myInfo').innerText = c + " " + n + "ë‹˜";
            db.ref('players').once('value', s => { if (s.numChildren() === 1) db.ref('turn').set(myId); });
        }

        db.ref('bomb').on('value', s => {
            const b = s.val();
            const alertDiv = document.getElementById('bombAlert');
            if (b && b.owner === myId) {
                // â˜… í­íƒ„ ë²Œì¹™ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
                alertDiv.innerHTML = `
                    <div style="font-size:20px; margin-bottom:10px;">ğŸ’£ í­íƒ„ ë³´ìœ  ì¤‘! (ë‚¨ì€ í„´: ${b.timer})</div>
                    <div style="background:rgba(255,255,255,0.9); color:black; padding:10px; border-radius:8px; font-size:14px; text-align:left;">
                        <strong>â˜ ï¸ í„°ì§€ë©´ ì´ ì¤‘ í•˜ë‚˜!</strong><br>
                        1. ğŸ¥ƒ ì†Œì£¼ í° ì” ì›ìƒ·<br>
                        2. ğŸ“¸ ì—½ì‚¬ ì¸ìŠ¤íƒ€ ë°•ì œ<br>
                        3. ğŸ¤« ì§„ì‹¤ or ìª½íŒ”ë¦° ì°
                    </div>
                `;
                alertDiv.style.display = "block";
                
                if (b.timer <= 0) {
                    const penalty = bombPenalties[Math.floor(Math.random() * bombPenalties.length)];
                    showAlert("ğŸ’¥ í­íƒ„ì´ í„°ì¡ŒìŠµë‹ˆë‹¤!", `<span style='color:red'>${penalty}</span>`, "í›„ë³´: 1.ì†Œì£¼ ì›ìƒ· / 2.ìŠ¤í† ë¦¬ ì—…ëƒ / 3.ì§„ì‹¤ ë§í•˜ê¸°", "theme-red");
                    db.ref('bombExplode').set(penalty);
                    db.ref('bomb').remove();
                    db.ref('players/' + myId + '/drinkCount').transaction(c => (c || 0) + 1);
                }
            } else { alertDiv.style.display = "none"; }
        });

        db.ref('slotResult').on('value', s => {
            const result = s.val();
            if (result) {
                showAlert("ğŸ° ëœë¤ê²Œì„ ê²°ê³¼!", `<span style='color:#2196f3; font-size:30px;'>${result}</span>`, "TV í™”ë©´ì„ í™•ì¸í•˜ì„¸ìš”!", "theme-blue");
            }
        });

        db.ref('players').on('value', s => {
            const ps = s.val();
            if (!ps) { if(document.getElementById('game').style.display === 'block') { alert("ê²Œì„ ì´ˆê¸°í™”ë¨"); location.reload(); } return; }
            playerList = Object.keys(ps).map(k=>({key:k, ...ps[k]})).sort((a,b)=>a.time - b.time);
        });

        db.ref('turn').on('value', s => {
            const tId = s.val();
            const btn = document.getElementById('rollBtn');
            const status = document.getElementById('status');
            if((!tId || !playerList.find(p => p.key === tId)) && playerList.length > 0) { db.ref('turn').set(playerList[0].key); return; }
            if (tId === myId) {
                btn.disabled = false;
                status.innerText = "ğŸ”” ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤! êµ´ë¦¬ì„¸ìš”!";
                status.style.color = "#ff4757";
                if(navigator.vibrate) navigator.vibrate(200);
            } else {
                btn.disabled = true;
                const turnOwner = playerList.find(p => p.key === tId);
                status.innerText = (turnOwner ? turnOwner.name : "ëˆ„êµ°ê°€") + "ë‹˜ì´ ì§„í–‰ ì¤‘...";
                status.style.color = "#555";
            }
        });

        db.ref('suddenDeath').on('value', s => { const d = s.val(); if(d) showAlert("ğŸš¨ ì„œë“ ë°ìŠ¤ ë°œë™!", d.text, "", "theme-red"); });
        db.ref('miniGameAlert').on('value', s => { const al = s.val(); if(al && al[myId]) showAlert("âš”ï¸ ë¯¸ë‹ˆê²Œì„ ë°œë™!", "TV í™”ë©´ì„ í™•ì¸í•˜ì„¸ìš”!", "ë¼ì´ë²Œê³¼ ëŒ€ê²°!", "theme-orange"); });

        function roll() {
            const dice = Math.floor(Math.random() * 6) + 1;
            currentPos = (currentPos + dice) % 28;
            let action = "";
            
            // â˜… "ë’¤ë¡œí•œì¹¸"ì´ ì—†ëŠ” ìˆ˜ì •ëœ ë°°ì—´ ì ìš©
            const penalties = ["ì‹œì‘!", "í•œì” ë§ˆì…”", "ì˜†ì‚¬ëŒ ë§ˆì…”", "ğŸ’£í­íƒ„ íšë“", "ğŸ®ëœë¤ê²Œì„", "íŒ¨ìŠ¤~", "ì±Œë¦°ì§€ ë…¸ë˜ì¶”ê¸°", "21í•™ë²ˆ ë§ˆì…”", "ë‘ì” ë§ˆì…”", "ëª¨ë‘ ë§ˆì…”", "í•œ í„´ í• ë¨¸ë‹ˆ", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ğŸ’£í­íƒ„ íšë“", "ëˆ„êµ¬ ë§ˆì…”", "ì˜†ì‚¬ëŒ ë§ˆì…”", "ë‚˜ë§Œ ë¹¼ê³  ë§ˆì…”", "ë„ˆë§Œ ë¹¼ê³  ë§ˆì…”", "23í•™ë²ˆ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "ğŸ®ëœë¤ê²Œì„", "íŒ¨ìŠ¤~", "ë²Œì£¼ ë§ˆì…”~", "í•œ í„´ ê³ ì–‘ì´", "ê°™ì´ ë§ˆì…”~", "ëª¨ë‘ ë§ˆì…”", "ğŸ—ï¸í™©ê¸ˆì—´ì‡ ", "í•œ ì” ë§ˆì…”", "ë„ì°©ê¸°ë… ë§ˆì…”~"];
            
            const currentCell = penalties[currentPos];
            if (currentCell.includes("ë§ˆì…”")) db.ref('players/' + myId + '/drinkCount').transaction(c => (c || 0) + 1);
            
            if (currentCell.includes("í­íƒ„")) {
                const totalTimer = playerList.length * 3;
                db.ref('bomb').set({ owner: myId, timer: totalTimer });
                showAlert("ğŸ’£ í­íƒ„ íšë“!", `3ë°”í€´(${totalTimer}í„´) ë’¤ì— í„°ì§‘ë‹ˆë‹¤!`, "", "theme-red");
                // "ë’¤ë¡œ" ë¡œì§ ì‚­ì œë¨
            } else {
                db.ref('bomb').transaction(b => { if (b) return { ...b, timer: b.timer - 1 }; return b; });
            }
            if(currentCell.includes("í™©ê¸ˆì—´ì‡ ")) {
                const key = allKeys[Math.floor(Math.random() * allKeys.length)];
                action = privateKeys.includes(key) ? "SECRET" : key;
                document.getElementById('storageText').innerText = key;
                document.getElementById('goldenKeyStorage').style.display = 'block';
            }
            if(currentCell.includes("ëœë¤ê²Œì„")) {
                document.getElementById('randomGameBtnArea').style.display = 'block';
                showAlert("ğŸ® ëœë¤ê²Œì„!", "ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŠ¬ë¡¯ì„ ëŒë¦¬ì„¸ìš”!", "", "theme-blue");
            } else { document.getElementById('randomGameBtnArea').style.display = 'none'; }
            db.ref('players/' + myId).update({ pos: currentPos, action: action });
            const nextIdx = (playerList.findIndex(p => p.key === myId) + 1) % playerList.length;
            db.ref('turn').set(playerList[nextIdx].key);
        }

        function triggerSlotMachine() { db.ref('slotTrigger').set(true); document.getElementById('randomGameBtnArea').style.display = 'none'; }
        
        function showAlert(title, text, subText = "", theme = "") {
            const overlay = document.getElementById('alertOverlay');
            overlay.className = theme;
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertText').innerHTML = text;
            document.getElementById('alertSubText').innerText = subText;
            overlay.style.display = 'flex'; // â˜… ì¤‘ì•™ ì •ë ¬ CSSê°€ ì ìš©ë¨
            if(navigator.vibrate) navigator.vibrate([500,200,500]);
        }
    </script>
</body>
</html>